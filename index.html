<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Macaualy2 in Browser</title>
  <script src="build/libv86.js"></script>
</head>

<body>
<div id="screen_container">
  <div style="white-space: pre; font: 14px monospace; line-height: 14px"></div>
  <canvas style="display: none"></canvas>
</div>

<script>
"use strict";

/**
 * Load debian-state-base.bin.part1, part2, ...
 * Merge into a single Blob and return a Blob URL
 */
async function createStateBlobUrl(baseName) {
    const parts = [];
    let index = 1;

    while (true) {
        const url = `${baseName}.part${index}`;
        try {
            const resp = await fetch(url);
            if (!resp.ok) break;
            parts.push(await resp.arrayBuffer());
            index++;
        } catch (e) {
            break;
        }
    }

    if (parts.length === 0) {
        throw new Error("No state file parts found");
    }

    const blob = new Blob(parts, { type: "application/octet-stream" });
    return URL.createObjectURL(blob);
}

window.onload = async function () {
    try {
        const screen = document.getElementById("screen_container");

        // Merge the split state file
        const stateUrl = await createStateBlobUrl(
            "images/debian-state-base.bin"
        );

        // Start v86
        const emulator = new V86({
            wasm_path: "build/v86.wasm",
            memory_size: 1024 * 1024 * 1024,
            vga_memory_size: 8 * 1024 * 1024,
            screen_container: screen,

            // IMPORTANT: use merged Blob URL here
            initial_state: { url: stateUrl },

            filesystem: {
                baseurl: "images/debian-9p-rootfs-flat/"
            },

            autostart: true,
        });

    } catch (e) {
        console.error(e);
        alert("Failed to load Debian state: " + e.message);
    }
};
</script>
</body>
</html>
